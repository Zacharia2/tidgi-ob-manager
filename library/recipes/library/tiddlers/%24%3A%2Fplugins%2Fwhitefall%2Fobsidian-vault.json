{"author":"whitefall","core-version":">=5.3.0","dependents":"$:/plugins/tiddlywiki/markdown","description":"Obsidian Vault发布工具 by NodeJS TiddlyWiki","list":"ui/Panel readme","name":"Obsidian Vault","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/plugins/whitefall/obsidian-vault/readme\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/readme\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"! tw5-obsidian-vault\\n\\nTidGi ≥ v0.8.0 需要在工作区设置 博客和服务器设置中 启用 HTTP API 并 关闭 凭证鉴权选项。\\n\\n# 在文本框中输入ob库文件夹路径，点击Add按钮。\\n# 你可以使用purge按钮清空添加的内容。\\n# 你可以在开发者模式-控制台中观看到正在进行的操作。\\n\\n!! ignore表达式\\n\\n默认表达式：留空即默认忽略 \\\".git\\\", \\\".obsidian\\\", \\\".stfolder\\\", \\\".stversions\\\" 四个文件夹。\\n\\n附加表达式：可以在ignore输入框输入`+文件夹名称, 文件夹名称, ...`，注意首字母必须为`+`，忽略更多文件夹。注意是英文逗号。\\n\\n自定义表达式：若首字母非`+`字符，则为自定义忽略文件夹。\\n\\n!! 过滤文件表达式\\n\\n使用正则表达式匹配文件中是否含有匹配内容，如“def:pub”，若文件夹中有此表达式则检出写入wiki中。\\n\\n\\n\\n项目介绍及仓库地址：https://github.com/tiddly-gittly/tidgi-obsidian-manager\"},\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\",\"text\":\"!function(){\\\"use strict\\\";exports.method=\\\"GET\\\",exports.path=/^\\\\/obvault\\\\/(.+)$/,exports.handler=function(e,t,s){var a,i,n,r,o,p,l=require(\\\"path\\\"),d=require(\\\"fs\\\"),c=$tw.utils.decodeURIComponentSafe(s.params[0]),u=s.queryParameters,g=function(e,t){var t=t||[\\\".git\\\",\\\".obsidian\\\"],a=[];if(!d.lstatSync(e).isDirectory())return s.sendResponse(400,{\\\"Content-Type\\\":\\\"text/plain\\\"},\\\"Not folder: \\\"+e),!1;for(const n of d.readdirSync(e)){var i=l.join(e,n);d.statSync(i).isFile()?a.push(i):t.includes(n)||(i=g(i),a=a.concat(i))}return a},m=function(e,t){return e=e.replace(/\\\\\\\\/g,\\\"/\\\"),(t=t.replace(/\\\\\\\\/g,\\\"/\\\")).slice(e.length+1)},f=g(c,u.ignore);0!=f&&(a=f,i=u.regText,o={obVaultName:c.split(\\\"/\\\").pop()||\\\"-\\\",mdFiles:{},imgFiles:{}},p=i||\\\"\\\",a.forEach(e=>{n=l.basename(e),r=l.extname(n),-1!==[\\\".jpg\\\",\\\".jpeg\\\",\\\".png\\\"].indexOf(r)?o.imgFiles[n]?o.imgFiles[n].push({path:m(c,e),data:d.readFileSync(e).toString(\\\"base64\\\")}):o.imgFiles[n]=[{path:m(c,e),data:d.readFileSync(e).toString(\\\"base64\\\")}]:\\\".md\\\"===r&&(r=d.readFileSync(e,\\\"utf8\\\"),RegExp(p).test(r))&&(o.mdFiles[n]?o.mdFiles[n].push({path:m(c,e),data:r}):o.mdFiles[n]=[{path:m(c,e),data:r}])}),f=o,u=JSON.stringify(f),s.sendResponse(200,{\\\"Content-Type\\\":\\\"application/json\\\"},u))}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\"#ob-widget-path{width:100%;height:100%;line-height:100%;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}\"},\"$:/plugins/whitefall/obsidian-vault/ui/Panel\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/Panel\",\"type\":\"text/vnd.tiddlywiki\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"OBM-Panel\",\"text\":\"<$obm/>\\n\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\",\"text\":\"\\\\whitespace trim\\n<h2 class=\\\"tc-title\\\">\\n{{!!caption}}\\n</h2>\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\",\"tags\":\"$:/tags/ViewTemplateTitleFilter\",\"list-before\":\"$:/config/ViewTemplateTitleFilters/default\",\"text\":\"[<currentTiddler>has[obvault]has[caption]then[$:/plugins/whitefall/obsidian-vault/ui/displayCaption]]\"},\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\",\"tags\":\"$:/tags/SideBar\",\"caption\":\"VaultTrees\",\"text\":\"\\n\\\\procedure leaf-link(full-title,chunk,separator: \\\"/\\\")\\n<$link to=<<full-title>>><$text text=<<chunk>>/></$link>\\n\\\\end\\n\\n\\\\procedure leaf-node(prefix,chunk)\\n\\\\whitespace trim\\n<li>\\n<$list filter=\\\"[<chunk>is[shadow]] [<chunk>is[tiddler]]\\\" variable=\\\"full-title\\\">\\n<span>{{$:/core/images/file}}</span>&#32;<$macrocall $name=\\\"leaf-link\\\" full-title=<<full-title>> chunk=<<chunk>>/>\\n</$list>\\n</li>\\n\\\\end\\n\\n\\\\procedure branch-node(prefix,chunk,separator: \\\"/\\\",vaultname)\\n\\\\whitespace trim\\n<li>\\n<$set name=\\\"reveal-state\\\" value={{{ [[$:/state/tree/]addsuffix<prefix>addsuffix<chunk>] }}}>\\n<$reveal type=\\\"nomatch\\\" stateTitle=<<reveal-state>> text=\\\"show\\\">\\n<$button setTitle=<<reveal-state>> setTo=\\\"show\\\" class=\\\"tc-btn-invisible\\\">\\n{{$:/core/images/folder}}&#32;<$text text=<<chunk>>/>\\n</$button>\\n</$reveal>\\n<$reveal type=\\\"match\\\" stateTitle=<<reveal-state>> text=\\\"show\\\">\\n<$button setTitle=<<reveal-state>> setTo=\\\"hide\\\" class=\\\"tc-btn-invisible\\\">\\n{{$:/core/images/folder}}&#32;<$text text=<<chunk>>/>\\n</$button>\\n</$reveal>\\n&#32;\\n<span>(<$count filter=\\\"[field:obvault<vaultname>get[vaulttree]removeprefix<prefix>removeprefix<chunk>] -[<prefix>addsuffix<chunk>]\\\"/>)</span>\\n<$reveal type=\\\"match\\\" stateTitle=<<reveal-state>> text=\\\"show\\\">\\n<$macrocall $name=\\\"tree-node\\\" prefix={{{ [<prefix>addsuffix<chunk>] }}} separator=<<separator>> vaultname=<<vaultname>>/>\\n</$reveal>\\n</$set>\\n</li>\\n\\\\end\\n\\n\\\\procedure tree-node(prefix,separator: \\\"/\\\",vaultname)\\n\\\\whitespace trim\\n<ol>\\n<$list filter=\\\"[field:obvault<vaultname>get[vaulttree]removeprefix<prefix>splitbefore<separator>sort[]!suffix<separator>]\\\" variable=\\\"chunk\\\">\\n<$macrocall $name=\\\"leaf-node\\\" prefix=<<prefix>> chunk=<<chunk>> separator=<<separator>>/>\\n</$list>\\n<$list filter=\\\"[field:obvault<vaultname>get[vaulttree]removeprefix<prefix>splitbefore<separator>sort[]suffix<separator>]\\\" variable=\\\"chunk\\\">\\n<$macrocall $name=\\\"branch-node\\\" prefix=<<prefix>> chunk=<<chunk>> separator=<<separator>> vaultname=<<vaultname>>/>\\n</$list>\\n</ol>\\n\\\\end\\n\\n\\\\procedure tree(prefix: \\\"$:/\\\",separator: \\\"/\\\")\\n\\\\whitespace trim\\n<div class=\\\"tc-tree\\\">\\n<span><center><p>Obsidian Vault<sup><$link to=\\\"$:/plugins/whitefall/obsidian-vault/ui/Panel\\\">p</$link></sup>&nbsp;文件列表</p></center></span>\\n<$list filter=\\\"[get[obvault]unique[]]\\\">\\n<span><strong><$text text=<<currentTiddler>>/></strong></span>\\n<div>\\n<$macrocall $name=\\\"tree-node\\\" vaultname=<<currentTiddler>> prefix=<<prefix>> separator=<<separator>>/>\\n</div>\\n</$list>\\n</div>\\n\\\\end\\n\\n<<tree>>\\n\\n<!-- \\n[get[obvault]unique[]]\\n[field:obvault[Neural-Networks]get[vaulttree]]\\n条目名必须和字段路径中的名字一致。\\n-->\\n\"},\"$:/plugins/whitefall/obsidian-vault/obsidian-main.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/obsidian-main.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"obsidian-main.ts\",\"text\":\"\\\"use strict\\\";var import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\"),SyncServer=class{constructor(){this.setupListener()}setupListener(){$tw.rootWidget.addEventListener(\\\"tw-obsidian-add\\\",async t=>{var e;\\\"tw-obsidian-add\\\"===t.type&&(e=await this.fetchData(t.param[0],t.param[1],t.param[2]),console.log(e),0!=e)&&this.addVault(e)}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-purge\\\",async t=>{this.purgeVault()}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-update\\\",async t=>{})}tm_notify(t,e){$tw.wiki.addTiddler({title:\\\"$:/state/notification/\\\"+t,text:t+\\\": \\\"+e}),$tw.notifier.display(\\\"$:/state/notification/\\\"+t)}async wiki_markdown_syntax(t){return t.replace(/\\\\!\\\\[\\\\[([^|]*?)\\\\]\\\\]/g,\\\"[img[$1]]\\\").replace(/\\\\!\\\\[\\\\[(.*?)\\\\|(.*?)\\\\|*(\\\\d+)\\\\]\\\\]/g,\\\"[img width=$3 [$1]]\\\").replace(/\\\\!\\\\[\\\\]\\\\((.*?)\\\\)/g,\\\"[img[$1]]\\\").replace(/\\\\!\\\\[(.*?)\\\\]\\\\((.*?)\\\\)/g,\\\"[img[$1|$2]]\\\").replace(/\\\\[\\\\[(?!.*!).*?\\\\|.*?\\\\]\\\\]/,\\\"[[$2|$1]]\\\")}async addVault(t){console.log(\\\"vaultName: \\\"+t.obVaultName);for(const w in t.mdFiles){var e=t.mdFiles[w];if(0!=e.length&&1==e.length){var i=await this.wiki_markdown_syntax(e[0].data),a=w.split(\\\".\\\")[0];$tw.wiki.addTiddler(new $tw.Tiddler({title:a,type:\\\"text/markdown\\\",text:i,obvault:t.obVaultName,vaulttree:\\\"$:/\\\"+e[0].path.split(\\\".\\\")[0]})),console.log(\\\"创建条目：\\\"+a)}else if(1<e.length)for(const p in e){var o=e[p],n=await this.wiki_markdown_syntax(o.data),d=o.path.split(\\\".\\\")[0];$tw.wiki.addTiddler(new $tw.Tiddler({title:d,type:\\\"text/markdown\\\",text:n,obvault:t.obVaultName,vaulttree:\\\"$:/\\\"+o.path.split(\\\".\\\")[0]})),console.log(\\\"创建同名异径条目：\\\"+d)}}for(const m in t.imgFiles){var l=t.imgFiles[m];if(0!=l.length&&1==l.length){var r=m,s=\\\"image/\\\"+r.substring(r.lastIndexOf(\\\".\\\")+1);$tw.wiki.addTiddler(new $tw.Tiddler({title:r,type:s,text:l[0].data,obvault:t.obVaultName})),console.log(\\\"创建图片条目：\\\"+r)}else if(1<l.length)for(const b in l){var g=l[b],u=g.path,c=\\\"image/\\\"+u.substring(u.lastIndexOf(\\\".\\\")+1);$tw.wiki.addTiddler(new $tw.Tiddler({title:u,type:c,text:g.data,obvault:t.obVaultName})),console.log(\\\"创建图片条目：\\\"+u)}}console.log(\\\"addVault: 所有添加工作已完成。\\\"),this.tm_notify(\\\"addVault\\\",\\\"所有添加工作已完成，请等待【文件系统同步服务】完成任务。\\\")}async purgeVault(t){var e=$tw.wiki.filterTiddlers(\\\"[has:field[obvault]]\\\");0!==e.length?(e.forEach(t=>{console.log(\\\"删除条目：\\\"+t),$tw.wiki.deleteTiddler(t)}),this.tm_notify(\\\"purgeVault\\\",\\\"已经完全清空，请等待【文件系统同步服务】完成任务。\\\")):this.tm_notify(\\\"purgeVault\\\",\\\"未曾添加Obsidian仓库，写入记录为空。\\\")}async fetchData(t,e,i){var a,o=[\\\".git\\\",\\\".obsidian\\\",\\\".stfolder\\\",\\\".stversions\\\"],o=(\\\"\\\"===i&&(a=JSON.stringify(o)),\\\"\\\"===i&&\\\"+\\\"!==i.at(0)||(n=i.substring(1).replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(o.concat(n))),\\\"\\\"!==i&&\\\"+\\\"!==i.at(0)&&(n=i.replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(n)),$tw.wiki.getTiddlerText(\\\"$:/info/url/full\\\")),n=o+\\\"obvault/\\\"+t+`?regText=${e}&ignore=`+a,o=(console.log(\\\"获取数据:\\\"+n),this.tm_notify(\\\"获取数据 (fetchData)  \\\",`\\\"${n}\\\"`),await fetch(n));return 400==o.status?(this.tm_notify(\\\"获取数据 (fetchData)  \\\",\\\"Not Folder\\\"),!1):(a=await o.json(),console.log(\\\"获取完成, 正在写入到wiki中。\\\"),this.tm_notify(\\\"获取数据 (fetchData)  \\\",\\\"获取完成, 正在写入到wiki中\\\"),a)}},ObMainWidget=class extends import_widget.widget{refresh(t){return!1}async render(t,e){this.parentDomNode=t,this.execute();const i=new SyncServer;var a=document.createElement(\\\"div\\\"),a=(a.innerHTML=`\\n    <div class=\\\"ob-main-widget-input\\\">\\n      <label for=\\\"path\\\">文件夹路径: </label>\\n      <input type=\\\"text\\\" id=\\\"ob-widget-path\\\" name=\\\"path\\\" placeholder=\\\"请输入路径。\\\">\\n      <label for=\\\"reg\\\">过滤文件: </label>\\n      <input type=\\\"text\\\" id=\\\"ob-widget-regText\\\" name=\\\"reg\\\" placeholder=\\\"请输入表达式\\\">\\n      <label for=\\\"ignore\\\">ignore: </label>\\n      <input type=\\\"text\\\" id=\\\"ob-widget-ignore\\\" name=\\\"ignore\\\" placeholder=\\\"请输入表达式\\\">\\n    </div>\\n    <button class=\\\"ob-main-widget-button\\\" id=\\\"ob-button-Add\\\" title=\\\"点击添加OB库\\\">Add</button>\\n    <button class=\\\"ob-main-widget-button\\\" id=\\\"ob-button-purge\\\" title=\\\"点击清空已添加的OB库\\\">purge</button>\\n    `,this.domNodes.push(t.appendChild(a)),document.getElementById(\\\"ob-button-Add\\\")),o=document.getElementById(\\\"ob-button-purge\\\");const n=document.getElementById(\\\"ob-widget-path\\\"),d=document.getElementById(\\\"ob-widget-regText\\\"),l=document.getElementById(\\\"ob-widget-ignore\\\");a.onclick=function(){0==n.value.length?(console.log(\\\"输入为空！\\\"),i.tm_notify(\\\"addVault\\\",\\\"输入为空！\\\")):$tw.rootWidget.dispatchEvent({type:\\\"tw-obsidian-add\\\",param:[n.value,d.value,l.value]})},o.onclick=function(){$tw.rootWidget.dispatchEvent({type:\\\"tw-obsidian-purge\\\"})}}};exports.obm=ObMainWidget;\"}}}","title":"$:/plugins/whitefall/obsidian-vault","type":"application/json","version":"0.0.10","Modern.TiddlyDev#SHA256-Hashed":"80dc3bd57a3124ad7144005846ec9edf189761b36654e873df3444b70882cb9e"}