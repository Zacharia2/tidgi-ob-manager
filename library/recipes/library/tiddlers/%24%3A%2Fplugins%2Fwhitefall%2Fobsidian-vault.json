{"author":"whitefall","core-version":">=5.2.0","dependents":"$:/plugins/tiddlywiki/markdown","description":"从 Obsidian 笔记库导入 Markdown 文件到 TiddlyWiki","list":"readme ui/Panel","name":"Obsidian Vault","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/plugins/whitefall/obsidian-vault/readme\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/readme\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"! tw5-obsidian-vault\\n\\n使用方式请查看：[[参考手册|https://tiddly-gittly.github.io/tidgi-obsidian-manager/]]\\n\\nGithub Repo: https://github.com/tiddly-gittly/tidgi-obsidian-manager\"},\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/router/get-obvault.js\",\"text\":\"!function(){\\\"use strict\\\";exports.method=\\\"GET\\\",exports.path=/^\\\\/obvault\\\\/(.+)$/,exports.handler=function(e,t,s){var i,a,r,n,p,o,d=require(\\\"path\\\"),l=require(\\\"fs\\\"),c=$tw.utils.decodeURIComponentSafe(s.params[0]),m=s.queryParameters,u=function(e,t){var t=t||[\\\".git\\\",\\\".obsidian\\\"],i=[];if(!l.lstatSync(e).isDirectory())return s.sendResponse(400,{\\\"Content-Type\\\":\\\"text/plain\\\"},\\\"Not folder: \\\"+e),!1;for(const r of l.readdirSync(e)){var a=d.join(e,r);l.statSync(a).isFile()?i.push(a):t.includes(r)||(a=u(a),i=i.concat(a))}return i},g=function(e,t){return e=e.replace(/\\\\\\\\/g,\\\"/\\\"),(t=t.replace(/\\\\\\\\/g,\\\"/\\\")).slice(e.length+1)},f=u(c,m.ignore);0!=f&&(i=f,a=m.regText,p={obVaultName:c.split(\\\"/\\\").pop()||\\\"-\\\",mdFiles:{},imgFiles:{},bp_peer:{}},o=a||\\\"\\\",i.forEach(e=>{r=d.basename(e),n=d.extname(r),p.bp_peer[r]?p.bp_peer[r].push(g(c,e)):p.bp_peer[r]=[g(c,e)];var t;-1!==[\\\".jpg\\\",\\\".jpeg\\\",\\\".png\\\",\\\".gif\\\",\\\".bmp\\\",\\\".svg\\\"].indexOf(n)?p.imgFiles[r]?p.imgFiles[r].push({path:g(c,e),data:l.readFileSync(e).toString(\\\"base64\\\")}):p.imgFiles[r]=[{path:g(c,e),data:l.readFileSync(e).toString(\\\"base64\\\")}]:\\\".md\\\"===n&&(n=l.readFileSync(e,\\\"utf8\\\"),t=l.statSync(e),RegExp(o).test(n))&&(p.mdFiles[r]?p.mdFiles[r].push({path:g(c,e),data:n,created:$tw.utils.stringifyDate(t.birthtime),modified:$tw.utils.stringifyDate(t.mtime)}):p.mdFiles[r]=[{path:g(c,e),data:n,created:$tw.utils.stringifyDate(t.birthtime),modified:$tw.utils.stringifyDate(t.mtime)}])}),f=p,m=JSON.stringify(f),s.sendResponse(200,{\\\"Content-Type\\\":\\\"application/json\\\"},m))}}();\",\"type\":\"application/javascript\",\"module-type\":\"route\"},\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/stylesheet/obsidian-main-style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\"#ob-widget-path{width:100%;height:100%;line-height:100%;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}\"},\"$:/plugins/whitefall/obsidian-vault/ui/Panel\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/Panel\",\"type\":\"text/vnd.tiddlywiki\",\"tags\":\"$:/tags/ControlPanel/SettingsTab\",\"caption\":\"obvault-Panel\",\"text\":\"\\n<$obvault/>\\n\\n<table style=\\\"width: 100%;border-collapse: collapse;\\\">\\n    <tr>\\n        <th>文件夹路径</th>\\n    </tr>\\n    <tr>\\n        <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-path\\\" size=\\\"48\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入路径\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    </tr>\\n</table>\\n\\n<table style=\\\"width: 100%;border-collapse: collapse;\\\">\\n  <tr>\\n    <th>过滤文件</th>\\n    <th>忽略文件夹</th>\\n  </tr>\\n  <tr>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-reg\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n    <td><$edit-text tiddler=\\\"$:/temp/obsidian-vault/input-box-ignore\\\" type=\\\"text\\\" tag=\\\"input\\\" default=\\\"\\\" placeholder=\\\"请输入表达式\\\" focus={{$:/plugins/whitefall/obsidian-vault/config/AutoFocus}} /></td>\\n  </tr>\\n</table>\\n\\n\\n<$set name='path' tiddler='$:/temp/obsidian-vault/input-box-path'>\\n<$set name='reg' tiddler='$:/temp/obsidian-vault/input-box-reg'>\\n<$set name='ignore' tiddler='$:/temp/obsidian-vault/input-box-ignore'>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-add\\\" path=<<path>> reg=<<reg>> ignore=<<ignore>> />add</$button>\\n  <$button><$action-sendmessage $message=\\\"tw-obsidian-purge\\\" />purge</$button>\\n</$set>\\n</$set>\\n</$set>\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaption\",\"text\":\"\\\\whitespace trim\\n<h2 class=\\\"tc-title\\\">\\n{{!!caption}}\\n</h2>\"},\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/displayCaptionFilter\",\"tags\":\"$:/tags/ViewTemplateTitleFilter\",\"list-before\":\"$:/config/ViewTemplateTitleFilters/default\",\"text\":\"[<currentTiddler>has[obvault]has[caption]then[$:/plugins/whitefall/obsidian-vault/ui/displayCaption]]\"},\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/ui/vaulttrees\",\"tags\":\"$:/tags/SideBar\",\"caption\":\"VaultTrees\",\"text\":\"\\n<div class=\\\"tc-tree-obv\\\">\\n<span><center><p>Obsidian Vault<sup><$link to=\\\"$:/plugins/whitefall/obsidian-vault/ui/Panel\\\">p</$link></sup>&nbsp;文件列表</p></center></span>\\n<<tree prefix:\\\"λ:/\\\">>\\n</div>\\n\\n<!-- \\n[get[obvault]unique[]]\\n[field:obvault[Neural-Networks]get[vaulttree]]\\n条目名必须和字段路径中的名字一致。\\n-->\\n\"},\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\":{\"title\":\"$:/plugins/whitefall/obsidian-vault/obvault-main.js\",\"type\":\"application/javascript\",\"module-type\":\"widget\",\"Modern.TiddlyDev#Origin\":\"obvault-main.ts\",\"text\":\"\\\"use strict\\\";var import_widget=require(\\\"$:/core/modules/widgets/widget.js\\\");function tm_notify(t,e){$tw.wiki.addTiddler({title:\\\"$:/state/notification/\\\"+t,text:t+\\\": \\\"+e}),$tw.notifier.display(\\\"$:/state/notification/\\\"+t)}async function fetchData(t,e,i){var a,l=[\\\".git\\\",\\\".obsidian\\\",\\\".stfolder\\\",\\\".stversions\\\"],l=(\\\"\\\"===i&&(a=JSON.stringify(l)),\\\"\\\"===i&&\\\"+\\\"!==i.at(0)||(n=i.substring(1).replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(l.concat(n))),\\\"\\\"!==i&&\\\"+\\\"!==i.at(0)&&(n=i.replace(/[ ]/g,\\\"\\\").split(\\\",\\\"),a=JSON.stringify(n)),$tw.wiki.getTiddlerText(\\\"$:/info/url/full\\\")),n=l+\\\"obvault/\\\"+t+`?regText=${e}&ignore=`+a,l=(console.log(\\\"获取数据:\\\"+n),tm_notify(\\\"获取数据 (fetchData)  \\\",`\\\"${n}\\\"`),await fetch(n));return 400==l.status?(tm_notify(\\\"获取数据 (fetchData)  \\\",\\\"Not Folder\\\"),!1):(a=await l.json(),console.log(\\\"获取完成, 正在写入到wiki中。\\\"),tm_notify(\\\"获取数据 (fetchData)  \\\",\\\"获取完成, 正在写入到wiki中\\\"),a)}function isUrl(t){return new RegExp(\\\"^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\\\\\\\S+(?::\\\\\\\\S*)?@)?(?:(?:(?:[1-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[01]\\\\\\\\d|22[0-3])(?:\\\\\\\\.(?:1?\\\\\\\\d{1,2}|2[0-4]\\\\\\\\d|25[0-5])){2}(?:\\\\\\\\.(?:[0-9]\\\\\\\\d?|1\\\\\\\\d\\\\\\\\d|2[0-4]\\\\\\\\d|25[0-4]))|(?:(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+-?)*[a-z\\\\\\\\u00a1-\\\\\\\\uffff0-9]+)*(?:\\\\\\\\.(?:[a-z\\\\\\\\u00a1-\\\\\\\\uffff]{2,})))|localhost)(?::\\\\\\\\d{2,5})?(?:(/|\\\\\\\\?|#)[^\\\\\\\\s]*)?$\\\",\\\"i\\\").test(t)}function links_wiki_syntax(e,t,i){var a={pattern:new RegExp(\\\"(?<!!)\\\\\\\\[\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\]\\\",\\\"g\\\"),target:\\\"[[$1]]\\\"},l=(new RegExp(\\\"(?<!!)\\\\\\\\[(.*?)\\\\\\\\]\\\\\\\\((.*?)\\\\\\\\)\\\",\\\"g\\\"),[...e.matchAll(a.pattern)]);for(const g in l){var n=l[g][1],r=l[g][0],o=n.split(\\\"|\\\"),n=o[0];if(1===o.length){if(isUrl(n))break;!isUrl(n)&&n.includes(\\\"/\\\")&&(e=e.replace(r,\\\"[[\\\"+o[0].split(\\\"/\\\").slice(-1)+\\\"|λ:/\\\"+i+\\\"/\\\"+o[0]+\\\"]]\\\"));var d=n+\\\".md\\\";if(d in t){var s=t[d];if(1===s.length&&(d=s[0].replace(/.md$/,\\\"\\\"))&&(e=e.replace(r,\\\"[[\\\"+o[0]+\\\"|λ:/\\\"+i+\\\"/\\\"+d+\\\"]]\\\")),1<s.length)for(const u in s){var f=s[u].replace(/.md$/,\\\"\\\");f.includes(\\\"/\\\")||(e=e.replace(r,\\\"[[\\\"+o[0]+\\\"|λ:/\\\"+i+\\\"/\\\"+f+\\\"]]\\\"))}}}if(1<o.length){isUrl(n)&&(e=e.replace(r,\\\"[[\\\"+o[1]+\\\"|\\\"+o[0]+\\\"]]\\\")),!isUrl(n)&&n.includes(\\\"/\\\")&&(e=e.replace(r,\\\"[[\\\"+o[1]+\\\"|λ:/\\\"+i+\\\"/\\\"+o[0]+\\\"]]\\\"));d=n+\\\".md\\\";if(d in t){var c,n=t[d];if(1===n.length&&(c=n[0].replace(/.md$/,\\\"\\\"))&&(e=e.replace(r,\\\"[[\\\"+o[1]+\\\"|λ:/\\\"+i+\\\"/\\\"+c+\\\"]]\\\")),1<n.length)for(const p in n){let t=t[p].replace(/.md$/,\\\"\\\");t.includes(\\\"/\\\")||(e=e.replace(r,\\\"[[\\\"+o[1]+\\\"|λ:/\\\"+i+\\\"/\\\"+t+\\\"]]\\\"))}}}}return e}function img_wiki_syntax(t){return t=(t=t.replace(/\\\\!\\\\[\\\\[(.*?)\\\\]\\\\]/g,(t,e)=>{var i=e.split(\\\"|\\\"),a=i[0].split(\\\".\\\").slice(-1);if(![\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\"].indexOf(a))return\\\"{{\\\"+e+\\\"}}\\\";if(1===i.length)return\\\"[img [\\\"+i[0]+\\\"]]\\\";if(1<i.length){a=+i.slice(-1)[0];if(\\\"number\\\"==typeof a)return\\\"[img width=\\\"+a+\\\" [\\\"+i[0]+\\\"]]\\\"}})).replace(/\\\\!\\\\[(.*?)\\\\]\\\\((.*?)\\\\)/g,(t,e,i)=>{var a=e.split(\\\"|\\\"),l=i,n=l.split(\\\".\\\").slice(-1);if(![\\\"jpg\\\",\\\"jpeg\\\",\\\"png\\\",\\\"gif\\\",\\\"bmp\\\",\\\"svg\\\",\\\"ico\\\"].indexOf(n))return t;if(0===a.length||\\\"\\\"===a[0])return\\\"[img [\\\"+l+\\\"]]\\\";if(1===a.length)return\\\"[img [\\\"+a[0]+\\\"|\\\"+l+\\\"]]\\\";if(1<a.length){n=+a.slice(-1)[0].split(\\\"x\\\")[0];if(\\\"number\\\"==typeof n)return\\\"[img width=\\\"+n+\\\" [\\\"+a[0]+\\\"|\\\"+l+\\\"]]\\\"}})}async function convert(t,e,i){return t=void 0!==t&&0!==t.length?links_wiki_syntax(t=img_wiki_syntax(t),e,i):t}async function addVault(t){console.log(\\\"vaultName: \\\"+t.obVaultName);var e=$tw.wiki.getTiddlerText(\\\"$:/status/UserName\\\");for(const p in t.mdFiles){var i=t.mdFiles[p];if(0!=i.length&&1==i.length){var a=await convert(i[0].data,t.bp_peer,t.obVaultName),l=\\\"λ:/\\\"+t.obVaultName+\\\"/\\\"+i[0].path.split(\\\".\\\")[0];$tw.wiki.addTiddler(new $tw.Tiddler({title:l,type:\\\"text/markdown\\\",caption:p.split(\\\".\\\")[0],created:i[0].created,modified:i[0].modified,modifier:e,text:a,obvault:t.obVaultName})),console.log(\\\"创建条目：\\\"+l)}else if(1<i.length)for(const m in i){var n=i[m],r=await convert(n.data,t.bp_peer,t.obVaultName),o=\\\"λ:/\\\"+t.obVaultName+\\\"/\\\"+n.path.split(\\\".\\\")[0];$tw.wiki.addTiddler(new $tw.Tiddler({title:o,type:\\\"text/markdown\\\",caption:n.path.split(\\\".\\\")[0].split(\\\"/\\\").slice(-1),created:n.created,modified:n.modified,modifier:e,text:r,obvault:t.obVaultName})),console.log(\\\"创建同名异径条目：\\\"+o)}}for(const w in t.imgFiles){var d=t.imgFiles[w];if(0!=d.length&&1==d.length){var s=w,f=\\\"image/\\\"+s.substring(s.lastIndexOf(\\\".\\\")+1);$tw.wiki.addTiddler(new $tw.Tiddler({title:s,type:f,text:d[0].data,obvault:t.obVaultName})),console.log(\\\"创建图片条目：\\\"+s)}else if(1<d.length)for(const h in d){var c=d[h],g=c.path,u=\\\"image/\\\"+g.substring(g.lastIndexOf(\\\".\\\")+1);$tw.wiki.addTiddler(new $tw.Tiddler({title:g,type:u,text:c.data,obvault:t.obVaultName})),console.log(\\\"创建图片条目：\\\"+g)}}console.log(\\\"addVault: 所有添加工作已完成。\\\"),tm_notify(\\\"addVault\\\",\\\"所有添加工作已完成，请等待【文件系统同步服务】完成任务。\\\")}async function purgeVault(t){var e=$tw.wiki.filterTiddlers(\\\"[has:field[obvault]]\\\");0!==e.length?(e.forEach(t=>{console.log(\\\"删除条目：\\\"+t),$tw.wiki.deleteTiddler(t)}),tm_notify(\\\"purgeVault\\\",\\\"已经完全清空，请等待【文件系统同步服务】完成任务。\\\")):tm_notify(\\\"purgeVault\\\",\\\"未曾添加Obsidian仓库，写入记录为空。\\\")}var ObvaultServer=class{constructor(){$tw.rootWidget.addEventListener(\\\"tw-obsidian-add\\\",async t=>{var e;this.isValidPath(t.paramObject.path)&&0!=(e=await fetchData(t.paramObject.path,t.paramObject.reg,t.paramObject.ignore))&&addVault(e)}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-purge\\\",async t=>{purgeVault()}),$tw.rootWidget.addEventListener(\\\"tw-obsidian-update\\\",async t=>{})}isValidPath(t){return\\\"\\\"===t?(console.log(\\\"路径为空！\\\"),tm_notify(\\\"addVault\\\",\\\"路径为空！\\\"),!1):!!/^(\\\\/|\\\\.\\\\.?\\\\/|([A-Za-z]:)?[\\\\\\\\|\\\\/])[^\\\\\\\\|\\\\/]+([\\\\\\\\|\\\\/][^\\\\\\\\|\\\\/]+)*[\\\\\\\\|\\\\/]?$/.test(t)||(console.log(\\\"无效路径！\\\"),tm_notify(\\\"addVault\\\",\\\"无效路径！\\\"),!1)}},ObVaultWidget=class extends import_widget.widget{refresh(t){this.computeAttributes();return!1}async render(t,e){this.parentDomNode=t,this.execute();new ObvaultServer}};exports.obvault=ObVaultWidget;\"}}}","title":"$:/plugins/whitefall/obsidian-vault","type":"application/json","version":"0.0.12","Modern.TiddlyDev#SHA256-Hashed":"75e49c1e241ee4d86ac4e3c63da49ab0b40e4301bdb3f55a7763c97bc82e1342"}